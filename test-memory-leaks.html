<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>px64 Memory Leak Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }

        .dynamic-content {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 0.25rem;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <h1>px64 Memory Leak Test</h1>
        <p>Testing automatic cleanup of observers and event listeners...</p>

        <div class="test-section">
            <h3>Dynamic Content Test</h3>
            <button class="btn btn-primary" onclick="addDynamicContent()">Add Dynamic Content</button>
            <button class="btn btn-secondary" onclick="removeDynamicContent()">Remove Dynamic Content</button>
            <div id="dynamic-container"></div>
        </div>

        <div class="test-section">
            <h3>Memory Usage</h3>
            <div id="memory-info">Click "Add Dynamic Content" to test...</div>
            <button class="btn btn-info" onclick="checkMemory()">Check Memory</button>
        </div>

        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results">Ready to test...</div>
        </div>
    </div>

    <script src="px64.js"></script>
    <script>
        let dynamicElements = [];
        let testCount = 0;

        function addDynamicContent() {
            testCount++;
            const container = document.getElementById('dynamic-container');

            // Create dynamic element with binders
            const dynamicDiv = document.createElement('div');
            dynamicDiv.className = 'dynamic-content';
            dynamicDiv.innerHTML = `
                <h5>Dynamic Element ${testCount}</h5>
                <div data-bind="text:message${testCount}">Loading...</div>
                <div data-bind="show:isVisible${testCount}">This should be visible</div>
                <div data-bind="fade:isFaded${testCount}">This should fade</div>
                <input type="text" data-bind="value:inputValue${testCount}" class="form-control" placeholder="Type here...">
                <button data-bind="tap:toggleVisibility${testCount}" class="btn btn-sm btn-outline-primary">Toggle</button>
            `;

            // Create scope for this element
            const scope = px64.observable({
                [`message${testCount}`]: `Dynamic message ${testCount}`,
                [`isVisible${testCount}`]: true,
                [`isFaded${testCount}`]: true,
                [`inputValue${testCount}`]: `Input ${testCount}`,
                [`toggleVisibility${testCount}`]() {
                    this.$set(`isVisible${testCount}`, !this[`isVisible${testCount}`]);
                }
            });

            // Bind the element
            px64.bind(dynamicDiv, scope);

            // Store references for cleanup testing
            dynamicElements.push({ element: dynamicDiv, scope });
            container.appendChild(dynamicDiv);

            updateTestResults();
        }

        function removeDynamicContent() {
            if (dynamicElements.length === 0) return;

            const { element } = dynamicElements.pop();
            element.remove(); // This should trigger automatic cleanup

            updateTestResults();
        }

        function checkMemory() {
            if (performance.memory) {
                const memory = performance.memory;
                const used = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                const total = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                const limit = Math.round(memory.jsHeapSizeLimit / 1024 / 1024);

                document.getElementById('memory-info').innerHTML = `
                    <strong>Memory Usage:</strong><br>
                    Used: ${used} MB<br>
                    Total: ${total} MB<br>
                    Limit: ${limit} MB<br>
                    Dynamic Elements: ${dynamicElements.length}
                `;
            } else {
                document.getElementById('memory-info').innerHTML = 'Memory API not available in this browser';
            }
        }

        function updateTestResults() {
            const results = document.getElementById('test-results');
            results.innerHTML = `
                <strong>Test Status:</strong><br>
                Dynamic Elements Created: ${testCount}<br>
                Dynamic Elements Active: ${dynamicElements.length}<br>
                <br>
                <strong>What to test:</strong><br>
                1. Add several dynamic elements<br>
                2. Interact with them (type, click buttons)<br>
                3. Remove them one by one<br>
                4. Check memory usage - should not increase significantly<br>
                5. All observers and event listeners should be automatically cleaned up
            `;
        }

        // Initial setup
        updateTestResults();
    </script>
</body>

</html>
