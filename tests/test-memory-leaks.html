<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>px64 Memory Leak Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }

        .dynamic-content {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 0.25rem;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <h1>px64 Memory Leak Test</h1>
        <p>Testing automatic cleanup of observers and event listeners...</p>

        <div class="test-section">
            <h3>Dynamic Content Test</h3>
            <button class="btn btn-primary" onclick="addDynamicContent()">Add Dynamic Content</button>
            <button class="btn btn-secondary" onclick="removeDynamicContent()">Remove Dynamic Content</button>
            <div id="dynamic-container"></div>
        </div>

        <div class="test-section">
            <h3>Memory Usage</h3>
            <div id="memory-info">Click "Add Dynamic Content" to test...</div>
            <button class="btn btn-info" onclick="checkMemory()">Check Memory</button>
        </div>

        <div class="test-section">
            <h3>ðŸ”§ New Fixes Test - attr: & class: Binder Cleanup</h3>
            <button class="btn btn-warning" onclick="testAttrClassCleanup()">Test attr: & class: Cleanup</button>
            <button class="btn btn-danger" onclick="testUnbindFunction()">Test px64.unbind()</button>
            <div id="fixes-test-results" class="mt-2">Click buttons to test new fixes...</div>
        </div>

        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results">Ready to test...</div>
        </div>
    </div>

    <script src="../px64.js"></script>
    <script>
        let dynamicElements = [];
        let testCount = 0;

        function addDynamicContent() {
            testCount++;
            const container = document.getElementById('dynamic-container');

            // Create dynamic element with binders
            const dynamicDiv = document.createElement('div');
            dynamicDiv.className = 'dynamic-content';
            dynamicDiv.innerHTML = `
                <h5>Dynamic Element ${testCount}</h5>
                <div data-bind="text:message${testCount}">Loading...</div>
                <div data-bind="show:isVisible${testCount}">This should be visible</div>
                <div data-bind="fade:isFaded${testCount}">This should fade</div>
                <input type="text" data-bind="value:inputValue${testCount}" class="form-control" placeholder="Type here...">
                <button data-bind="tap:toggleVisibility${testCount}" class="btn btn-sm btn-outline-primary">Toggle</button>
            `;

            // Create scope for this element
            const scope = px64.observable({
                [`message${testCount}`]: `Dynamic message ${testCount}`,
                [`isVisible${testCount}`]: true,
                [`isFaded${testCount}`]: true,
                [`inputValue${testCount}`]: `Input ${testCount}`,
                [`toggleVisibility${testCount}`]() {
                    this.$set(`isVisible${testCount}`, !this[`isVisible${testCount}`]);
                }
            });

            // Bind the element
            px64.bind(dynamicDiv, scope);

            // Store references for cleanup testing
            dynamicElements.push({ element: dynamicDiv, scope });
            container.appendChild(dynamicDiv);

            updateTestResults();
        }

        function removeDynamicContent() {
            if (dynamicElements.length === 0) return;

            const { element } = dynamicElements.pop();
            element.remove(); // This should trigger automatic cleanup

            updateTestResults();
        }

        function checkMemory() {
            if (performance.memory) {
                const memory = performance.memory;
                const used = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                const total = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                const limit = Math.round(memory.jsHeapSizeLimit / 1024 / 1024);

                document.getElementById('memory-info').innerHTML = `
                    <strong>Memory Usage:</strong><br>
                    Used: ${used} MB<br>
                    Total: ${total} MB<br>
                    Limit: ${limit} MB<br>
                    Dynamic Elements: ${dynamicElements.length}
                `;
            } else {
                document.getElementById('memory-info').innerHTML = 'Memory API not available in this browser';
            }
        }

        function updateTestResults() {
            const results = document.getElementById('test-results');
            results.innerHTML = `
                <strong>Test Status:</strong><br>
                Dynamic Elements Created: ${testCount}<br>
                Dynamic Elements Active: ${dynamicElements.length}<br>
                <br>
                <strong>What to test:</strong><br>
                1. Add several dynamic elements<br>
                2. Interact with them (type, click buttons)<br>
                3. Remove them one by one<br>
                4. Check memory usage - should not increase significantly<br>
                5. All observers and event listeners should be automatically cleaned up
            `;
        }

        // Initial setup
        updateTestResults();

        // Test attr: and class: binder cleanup fixes
        function testAttrClassCleanup() {
            const container = document.getElementById('fixes-test-results');
            
            // Create test element with attr: and class: binders
            const testEl = document.createElement('div');
            testEl.innerHTML = `
                <div data-bind="attr:title:dynamicTitle, class:highlight:isHighlighted" class="test-item">
                    <span data-bind="text:dynamicTitle">Test Element</span>
                </div>
            `;
            
            // Create scope
            const testScope = px64.observable({
                dynamicTitle: 'Initial Title',
                isHighlighted: false
            });
            
            // Bind element
            px64.bind(testEl, testScope);
            
            // Test that bindings work
            testScope.$set('dynamicTitle', 'Updated Title');
            testScope.$set('isHighlighted', true);
            
            // Remove element (should trigger cleanup)
            setTimeout(() => {
                testEl.remove();
                container.innerHTML = `
                    <div class="alert alert-success">
                        âœ… attr: & class: binder cleanup test completed!<br>
                        - Created element with attr: and class: binders<br>
                        - Updated values to test observers<br>
                        - Removed element to trigger cleanup<br>
                        - registerObserver calls should prevent memory leaks
                    </div>
                `;
            }, 1000);
            
            container.innerHTML = '<div class="alert alert-info">ðŸ”„ Testing attr: & class: binder cleanup...</div>';
        }

        // Test px64.unbind() function
        function testUnbindFunction() {
            const container = document.getElementById('fixes-test-results');
            
            // Create test element
            const testEl = document.createElement('div');
            testEl.id = 'unbind-test';
            testEl.innerHTML = `
                <div data-bind="text:message, class:active:isActive" class="test-item">
                    <span data-bind="text:counter">0</span>
                </div>
            `;
            document.body.appendChild(testEl);
            
            // Create scope and bind
            const testScope = px64.observable({
                message: 'Bound Element',
                isActive: true,
                counter: 0
            });
            
            px64.bind('#unbind-test', testScope);
            
            // Test that binding works
            testScope.$set('counter', 42);
            testScope.$set('message', 'Updated Message');
            
            // Test unbind function
            setTimeout(() => {
                const success = px64.unbind('#unbind-test');
                
                // Verify cleanup
                const hasDataBind = testEl.querySelector('[data-bind]');
                const hasScopeId = testEl.hasAttribute('data-scope-id');
                
                testEl.remove();
                
                container.innerHTML = `
                    <div class="alert alert-success">
                        âœ… px64.unbind() test completed!<br>
                        - Function returned: ${success}<br>
                        - data-bind attributes removed: ${!hasDataBind}<br>
                        - data-scope-id removed: ${!hasScopeId}<br>
                        - Element successfully unbound and cleaned up
                    </div>
                `;
            }, 1000);
            
            container.innerHTML = '<div class="alert alert-info">ðŸ”„ Testing px64.unbind() function...</div>';
        }

        // Initial setup
        updateTestResults();
    </script>
</body>

</html>
